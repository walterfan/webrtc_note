<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WebRTC Bundle &mdash; webrtc_tutorial 1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="3. WebRTC 媒体" href="../3.media/index.html" />
    <link rel="prev" title="Network Device Interface" href="webrtc_ndi.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            webrtc_tutorial
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../0.tutorial/index.html">0. WebRTC 简明教程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1.basic/index.html">1. WebRTC 基础</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">2. WebRTC 传输</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">WebRTC 传输概论</a></li>
<li class="toctree-l2"><a class="reference internal" href="websocket.html">WebSocket</a></li>
<li class="toctree-l2"><a class="reference internal" href="stun.html">STUN</a></li>
<li class="toctree-l2"><a class="reference internal" href="turn.html">TURN</a></li>
<li class="toctree-l2"><a class="reference internal" href="ice.html">Interactive Connectivity Establishment</a></li>
<li class="toctree-l2"><a class="reference internal" href="quic.html">QUIC 协议</a></li>
<li class="toctree-l2"><a class="reference internal" href="hls.html">HTTP Live Streaming</a></li>
<li class="toctree-l2"><a class="reference internal" href="tls.html">TLS 协议</a></li>
<li class="toctree-l2"><a class="reference internal" href="dtls.html">DTLS 协议</a></li>
<li class="toctree-l2"><a class="reference internal" href="sctp.html">SCTP 协议</a></li>
<li class="toctree-l2"><a class="reference internal" href="srtp.html">SRTP 协议</a></li>
<li class="toctree-l2"><a class="reference internal" href="whip.html">WHIP 协议</a></li>
<li class="toctree-l2"><a class="reference internal" href="rtp.html">WebRTC RTP Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="rtcp.html">WebRTC RTCP Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="webrtc_data_channel.html">WebRTC Data Channel</a></li>
<li class="toctree-l2"><a class="reference internal" href="rtp_header_extension.html">WebRTC RTP Header extension</a></li>
<li class="toctree-l2"><a class="reference internal" href="rtp_keepalive.html">RTP Keepalive</a></li>
<li class="toctree-l2"><a class="reference internal" href="webrtc_multiplex.html">WebRTC 传输的多路复用</a></li>
<li class="toctree-l2"><a class="reference internal" href="webrtc_ndi.html">Network Device Interface</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">WebRTC Bundle</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#what">What</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how">How</a></li>
<li class="toctree-l3"><a class="reference internal" href="#why">Why</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">简介</a></li>
<li class="toctree-l3"><a class="reference internal" href="#stun-dtls-rtp">1. 区分 STUN, DTLS 和 RTP 包</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rtp-rtcp">2. 区分 RTP 和 RTCP</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">3. 区分不同的媒体流</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rtcp-rtp-media-session-m-line">4. 关联 RTCP 与 RTP 数据包到相应的 media session(m-line)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">参考资料</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../3.media/index.html">3. WebRTC 媒体</a></li>
<li class="toctree-l1"><a class="reference internal" href="../4.code/index.html">4. WebRTC 源码分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../5.practice/index.html">5. WebRTC 实践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../6.tool/index.html">6. WebRTC 工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="../7.misc/index.html">7. WebRTC 关联技术</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">webrtc_tutorial</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">2. WebRTC 传输</a></li>
      <li class="breadcrumb-item active">WebRTC Bundle</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/2.transport/webrtc_bundle.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="webrtc-bundle">
<h1>WebRTC Bundle<a class="headerlink" href="#webrtc-bundle" title="Permalink to this heading"></a></h1>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p><strong>Abstract</strong></p></td>
<td><p>WebRTC Bundle</p></td>
</tr>
<tr class="row-even"><td><p><strong>Authors</strong></p></td>
<td><p>Walter Fan</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Status</strong></p></td>
<td><p>WIP as draft</p></td>
</tr>
<tr class="row-even"><td><p><strong>Updated</strong></p></td>
<td><p>2023-08-03</p></td>
</tr>
</tbody>
</table>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#what" id="id6">What</a></p></li>
<li><p><a class="reference internal" href="#how" id="id7">How</a></p></li>
<li><p><a class="reference internal" href="#why" id="id8">Why</a></p></li>
<li><p><a class="reference internal" href="#id3" id="id9">简介</a></p></li>
<li><p><a class="reference internal" href="#stun-dtls-rtp" id="id10">1. 区分 STUN, DTLS 和 RTP 包</a></p></li>
<li><p><a class="reference internal" href="#rtp-rtcp" id="id11">2. 区分 RTP 和 RTCP</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id12">3. 区分不同的媒体流</a></p></li>
<li><p><a class="reference internal" href="#rtcp-rtp-media-session-m-line" id="id13">4. 关联 RTCP 与 RTP 数据包到相应的 media session(m-line)</a></p></li>
<li><p><a class="reference internal" href="#id5" id="id14">参考资料</a></p></li>
</ul>
</nav>
<section id="what">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">What</a><a class="headerlink" href="#what" title="Permalink to this heading"></a></h2>
<p>RFC8843 defines a new Session Description Protocol (SDP) Grouping Framework extension called ‘BUNDLE’.
The extension can be used with the SDP offer/answer mechanism to negotiate the usage of a  single transport (5-tuple) for sending and receiving media described by multiple SDP media descriptions (“m=” sections).</p>
<p>Such transport is referred to as a BUNDLE transport, and the media is referred to as  bundled media.
The “m=” sections that use the BUNDLE transport form a BUNDLE group.</p>
<p>It sends all media flows (those m= lines in the SDP) using the same “5 tuple”, meaning from the same IP and port, to the same IP and port, and over the same transport protocol.</p>
</section>
<section id="how">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">How</a><a class="headerlink" href="#how" title="Permalink to this heading"></a></h2>
<p>In the JavaScript APIs for WebRTC, there is a configuration parameter called RTCConfiguration that is passed into the constructor when a new Peer Connection is created.</p>
<p>This object has properties for setting the STUN and TURN servers (iceServers), for indicating which paths to use for transport (iceTransportPolicy), for setting the peer identity policy (peerIdentity), and for controlling how BUNDLE is to be used (bundlePolicy).  Here is an example use of bundlePolicy:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>myConfig = {bundlePolicy: “max-bundle”};
pc = new RTCPeerConnection(myConfig);
</pre></div>
</div>
<p>There are three valid values that can be set for this policy:
* max-bundle,
* max-compat, and
* balanced.</p>
<p>In all cases the browser will attempt to bundle all tracks together over one connection (meaning a specific local IP/port and remote IP/port).</p>
<p>The different policy values affect what happens if the peer does not support BUNDLE.</p>
<p>So, if the peer does not support BUNDLE:</p>
<ul class="simple">
<li><p>max-bundle instructs the browser to pick one media track to negotiate and will only send that one</p></li>
<li><p>max-compat instructs the browser to separate each track into its own connection</p></li>
<li><p>balanced instructs the browser to pick two tracks to send — one audio and one video.  This is the default</p></li>
</ul>
<p>Note that max-compat is the most likely to be backwards compatible with non-BUNDLE-aware legacy devices.</p>
</section>
<section id="why">
<h2><a class="toc-backref" href="#id8" role="doc-backlink">Why</a><a class="headerlink" href="#why" title="Permalink to this heading"></a></h2>
<p>One obvious benefit of doing this is reducing the ICE negotiation time as the number of ICE candidates is reduced.</p>
<p>While there are clear benefits to using one single BUNDLE for all media flows when possible, there are sometimes requirements to separate media flows.</p>
<p>For example: to separate audio from video and bundle each media type. In this example this would result in 2 SDP BUNDLEs.</p>
</section>
<section id="id3">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">简介</a><a class="headerlink" href="#id3" title="Permalink to this heading"></a></h2>
<p>回顾一下这张经典的图</p>
<img alt="https://upload-images.jianshu.io/upload_images/1598924-a0b7b8dd85776b92.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="https://upload-images.jianshu.io/upload_images/1598924-a0b7b8dd85776b92.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" />
<p>我改了一下 audio 和 video 的 codec, 现在 Opus 和 H.264 用的比较多 Web
API 中最主要的就是 MediaStream, RTCPeerConnection 和 DataChannel.</p>
<p>在两个端点之间所传输的消息有这样几种</p>
<img alt="https://upload-images.jianshu.io/upload_images/1598924-305ba0be176396bc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="https://upload-images.jianshu.io/upload_images/1598924-305ba0be176396bc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" />
<p>媒体数据一般都是优先走 UDP</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="mi">0</span>                   <span class="mi">1</span>                   <span class="mi">2</span>                   <span class="mi">3</span>
 <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="o">|</span>           <span class="n">Source</span> <span class="n">Port</span>          <span class="o">|</span>        <span class="n">Destination</span> <span class="n">port</span>      <span class="o">|</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="o">|</span>               <span class="n">Length</span>           <span class="o">|</span>        <span class="n">Checksum</span>              <span class="o">|</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="o">|</span>                                                               <span class="o">|</span>
<span class="o">|</span>                        <span class="n">data</span> <span class="n">octets</span> <span class="o">...</span>                        <span class="o">|</span>
<span class="o">|</span>                                                               <span class="o">|</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</pre></div>
</div>
</section>
<section id="stun-dtls-rtp">
<h2><a class="toc-backref" href="#id10" role="doc-backlink">1. 区分 STUN, DTLS 和 RTP 包</a><a class="headerlink" href="#stun-dtls-rtp" title="Permalink to this heading"></a></h2>
<p>注: 这里提到的 RTP 包括 RTP, RTCP, SRTP, SRTCP</p>
<p>在 UDP 传输通道上会跑 STUN, DTLS 和 RTP(SRTP)
的数据，我们首先要区分这几种数据</p>
<ul class="simple">
<li><p>STUN 消息头如下</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="mi">0</span>                   <span class="mi">1</span>                   <span class="mi">2</span>                   <span class="mi">3</span>
 <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="o">|</span><span class="mi">0</span> <span class="mi">0</span><span class="o">|</span>     <span class="n">STUN</span> <span class="n">Message</span> <span class="n">Type</span>     <span class="o">|</span>         <span class="n">Message</span> <span class="n">Length</span>        <span class="o">|</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="o">|</span>                         <span class="n">Magic</span> <span class="n">Cookie</span>                          <span class="o">|</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="o">|</span>                                                               <span class="o">|</span>
<span class="o">|</span>                     <span class="n">Transaction</span> <span class="n">ID</span> <span class="p">(</span><span class="mi">96</span> <span class="n">bits</span><span class="p">)</span>                  <span class="o">|</span>
<span class="o">|</span>                                                               <span class="o">|</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</pre></div>
</div>
<ul class="simple">
<li><p>DTLS 消息，包含 SRTP 密钥的传输及用于 Datat Channel 的 SCTP 消息</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">struct</span> <span class="p">{</span>
       <span class="n">ContentType</span> <span class="nb">type</span><span class="p">;</span>
       <span class="n">ProtocolVersion</span> <span class="n">version</span><span class="p">;</span>
       <span class="n">uint16</span> <span class="n">epoch</span><span class="p">;</span>                                     <span class="o">//</span> <span class="n">New</span> <span class="n">field</span>
       <span class="n">uint48</span> <span class="n">sequence_number</span><span class="p">;</span>                           <span class="o">//</span> <span class="n">New</span> <span class="n">field</span>
       <span class="n">uint16</span> <span class="n">length</span><span class="p">;</span>
       <span class="n">opaque</span> <span class="n">fragment</span><span class="p">[</span><span class="n">DTLSPlaintext</span><span class="o">.</span><span class="n">length</span><span class="p">];</span>
<span class="p">}</span> <span class="n">DTLSPlaintext</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="mi">0</span>                   <span class="mi">1</span>                   <span class="mi">2</span>                   <span class="mi">3</span>
 <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="o">|</span> <span class="n">ContentType</span> <span class="o">|</span>        <span class="n">Version</span>     <span class="o">|</span>        <span class="n">epoch</span>               <span class="o">|</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="o">|</span>                         <span class="n">sequence_number</span>                       <span class="o">|</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="o">|</span>    <span class="n">sequence_number</span>              <span class="o">|</span>         <span class="n">length</span>              <span class="o">|</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="o">|</span>                                                               <span class="o">|</span>
<span class="o">|</span>                     <span class="n">opaque</span> <span class="n">fragment</span>                           <span class="o">|</span>
<span class="o">|</span>                                                               <span class="o">|</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</pre></div>
</div>
<ul class="simple">
<li><p>RTP 消息，包含音频或视频的媒体数据, SRTP 的头与 RTP 头是相同的</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="mi">0</span>                   <span class="mi">1</span>                   <span class="mi">2</span>                   <span class="mi">3</span>
 <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="o">|</span><span class="n">V</span><span class="o">=</span><span class="mi">2</span><span class="o">|</span><span class="n">P</span><span class="o">|</span><span class="n">X</span><span class="o">|</span>  <span class="n">CC</span>   <span class="o">|</span><span class="n">M</span><span class="o">|</span>     <span class="n">PT</span>      <span class="o">|</span>       <span class="n">sequence</span> <span class="n">number</span>         <span class="o">|</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="o">|</span>                           <span class="n">timestamp</span>                           <span class="o">|</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="o">|</span>           <span class="n">synchronization</span> <span class="n">source</span> <span class="p">(</span><span class="n">SSRC</span><span class="p">)</span> <span class="n">identifier</span>            <span class="o">|</span>
<span class="o">+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+</span>
<span class="o">|</span>            <span class="n">contributing</span> <span class="n">source</span> <span class="p">(</span><span class="n">CSRC</span><span class="p">)</span> <span class="n">identifiers</span>             <span class="o">|</span>
<span class="o">|</span>                             <span class="o">....</span>                              <span class="o">|</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</pre></div>
</div>
<ul class="simple">
<li><p>RTCP 包括各种报告和反馈消息， SRTCP 的头与 RTCP 头是相同的</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="mi">0</span>                   <span class="mi">1</span>                   <span class="mi">2</span>                   <span class="mi">3</span>
 <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="o">|</span><span class="n">V</span><span class="o">=</span><span class="mi">2</span><span class="o">|</span><span class="n">P</span><span class="o">|</span> <span class="n">RC</span><span class="o">/</span><span class="n">FMT</span>  <span class="o">|</span>       <span class="n">PT</span>      <span class="o">|</span>             <span class="n">length</span>            <span class="o">|</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="o">|</span>                         <span class="n">SSRC</span> <span class="n">of</span> <span class="n">sender</span>                        <span class="o">|</span>
<span class="o">|</span>                              <span class="o">...</span>                              <span class="o">|</span>
</pre></div>
</div>
<p>我们从包头的第一个字节就能够区分</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>            <span class="o">+----------------+</span>
            <span class="o">|</span> <span class="mi">127</span> <span class="o">&lt;</span> <span class="n">B</span> <span class="o">&lt;</span> <span class="mi">192</span> <span class="o">-+--&gt;</span> <span class="n">forward</span> <span class="n">to</span> <span class="n">RTP</span>
            <span class="o">|</span>                <span class="o">|</span>
<span class="n">packet</span> <span class="o">--&gt;</span>  <span class="o">|</span>  <span class="mi">19</span> <span class="o">&lt;</span> <span class="n">B</span> <span class="o">&lt;</span> <span class="mi">64</span>  <span class="o">-+--&gt;</span> <span class="n">forward</span> <span class="n">to</span> <span class="n">DTLS</span>
            <span class="o">|</span>                <span class="o">|</span>
            <span class="o">|</span>       <span class="n">B</span> <span class="o">&lt;</span> <span class="mi">2</span>   <span class="o">-+--&gt;</span> <span class="n">forward</span> <span class="n">to</span> <span class="n">STUN</span>
            <span class="o">+----------------+</span>
</pre></div>
</div>
<p>代码示例如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="p">((</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">))</span>
     <span class="k">return</span> <span class="n">stun</span><span class="p">;</span> <span class="o">//</span> <span class="n">STUN</span> <span class="n">packet</span>

<span class="k">if</span><span class="p">((</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">128</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;=</span><span class="mi">191</span><span class="p">))</span>
     <span class="k">return</span> <span class="n">rtp</span><span class="p">;</span> <span class="o">//</span> <span class="n">RTP</span> <span class="n">packet</span>

<span class="k">if</span><span class="p">((</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">20</span><span class="p">)</span>  <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;=</span><span class="mi">64</span><span class="p">))</span>
     <span class="k">return</span> <span class="n">dtls</span><span class="p">;</span> <span class="o">//</span> <span class="n">DTLS</span> <span class="n">packet</span>
</pre></div>
</div>
</section>
<section id="rtp-rtcp">
<h2><a class="toc-backref" href="#id11" role="doc-backlink">2. 区分 RTP 和 RTCP</a><a class="headerlink" href="#rtp-rtcp" title="Permalink to this heading"></a></h2>
<p>在一个端口上传输 RTP 和 RTCP 包会面临 payload 冲突的问题。RTCP
头的第二个字节是 payload type, RTP 头的第二个字节的低 7 位是 payload
type, RFC 5761 总结了一下，有如下冲突</p>
<ul class="simple">
<li><p>RTP 有效载荷类型 64-65 与原始“H.261 视频流的 RTP 有效载荷格式”（由
RFC 2032 定义，由 RFC 4587 废弃）中定义的（过时的）RTCP FIR 和 NACK
数据包冲突。</p></li>
<li><p>RTP 有效载荷类型 72-76 与 RTP 规范 (RFC3550) 中定义的 RTCP
SR、RR、SDES、BYE 和 APP 数据包冲突。</p></li>
<li><p>RTP 有效负载类型 77-78 与 RTP/AVPF 配置文件 (RFC 4585) 中定义的 RTCP
RTPFB 和 PSFB 数据包冲突。</p></li>
<li><p>RTP 负载类型 79 与 RTCP 扩展报告 (XR) (RFC 3611) 数据包冲突。</p></li>
<li><p>RTP 有效负载类型 80 与“具有单播反馈的单源多播会话的 RTCP 扩展”(RFC
5760) 中定义的接收器摘要信息 (RSI) 数据包冲突。</p></li>
</ul>
<p>也就是 RTP payload type 64 ~ 95 会和 RTCP 有冲突，所以根据 RFC3551
RTP/AVP profile 的规定，RFC 5761 建议 RTP payload 64 ~ 95 不要再使用，
RTP 的动态 payload type 的选择最好在 96 ~ 127 之间</p>
</section>
<section id="id4">
<h2><a class="toc-backref" href="#id12" role="doc-backlink">3. 区分不同的媒体流</a><a class="headerlink" href="#id4" title="Permalink to this heading"></a></h2>
<p>传统上，一个传输通道只传输一路媒体流，其 RTP 包 的 SSRC
也用来标识这路媒体流。 RTCP 会使用一个单独的传输 媒体协商的 SDP 中的一个
m-line 也只包含一路或者一对(包括重传 RTX 的媒体流 )媒体流。</p>
<p>WebRTC 中为避免过多地使用 NAT
技术来穿透防火墙，可用多路复用技术在一个传输通道中传输多路媒体，包括RTCP,
重传的媒体流。</p>
<p>一个传输通道（五元组: protocol, srcHost, srcPort, destHost,
destPort）中包含多路媒体流，也就是有多个 m-line。而一个 m-line
中也可包含多个 ssrc, 即通过联播 Simulcast 技术让 MediaStream 包含多个
MediaStreamTrack（分辨率或码率不同）。</p>
<p>那么如何辨别这些 MediaStream 和 MediaStreamTrack 呢？ SSRC 和 Payload
Type 显然不够，因为 SSRC 会变化，Payload Type 会重复。</p>
<p>WebRTC 将这些媒体流放在一个 bundle group 中， 通过 mid 来标识媒体流
MediaStream, 通过 rid 来标识媒体流中不同的 MediaStreamTrack,
例如来自相同源的不同质量，分辨率或帧率的流</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">v</span><span class="o">=</span><span class="mi">0</span>
<span class="n">o</span><span class="o">=-</span> <span class="mi">708564895714429943</span> <span class="mi">2</span> <span class="n">IN</span> <span class="n">IP4</span> <span class="mf">127.0.0.1</span>
<span class="n">s</span><span class="o">=-</span>
<span class="n">t</span><span class="o">=</span><span class="mi">0</span> <span class="mi">0</span>
<span class="n">a</span><span class="o">=</span><span class="n">group</span><span class="p">:</span><span class="n">BUNDLE</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span>
<span class="n">a</span><span class="o">=</span><span class="n">extmap</span><span class="o">-</span><span class="n">allow</span><span class="o">-</span><span class="n">mixed</span>
<span class="n">a</span><span class="o">=</span><span class="n">msid</span><span class="o">-</span><span class="n">semantic</span><span class="p">:</span> <span class="n">WMS</span> <span class="n">rb3Uanb7CQq8HfZe0gexpjwoNCQai0AbUoQB</span>
<span class="n">m</span><span class="o">=</span><span class="n">audio</span> <span class="mi">9</span> <span class="n">UDP</span><span class="o">/</span><span class="n">TLS</span><span class="o">/</span><span class="n">RTP</span><span class="o">/</span><span class="n">SAVPF</span> <span class="mi">111</span> <span class="mi">63</span> <span class="mi">103</span> <span class="mi">104</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">8</span> <span class="mi">106</span> <span class="mi">105</span> <span class="mi">13</span> <span class="mi">110</span> <span class="mi">112</span> <span class="mi">113</span> <span class="mi">126</span>
<span class="n">c</span><span class="o">=</span><span class="n">IN</span> <span class="n">IP4</span> <span class="mf">0.0.0.0</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtcp</span><span class="p">:</span><span class="mi">9</span> <span class="n">IN</span> <span class="n">IP4</span> <span class="mf">0.0.0.0</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">ufrag</span><span class="p">:</span><span class="n">u8aT</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">pwd</span><span class="p">:</span><span class="n">nTH</span><span class="o">+</span><span class="mi">98</span><span class="n">fL7o</span><span class="o">+</span><span class="n">XacAd</span><span class="o">//</span><span class="n">X7uStI</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">options</span><span class="p">:</span><span class="n">trickle</span>
<span class="n">a</span><span class="o">=</span><span class="n">fingerprint</span><span class="p">:</span><span class="n">sha</span><span class="o">-</span><span class="mi">256</span> <span class="mi">6</span><span class="n">E</span><span class="p">:</span><span class="n">FD</span><span class="p">:</span><span class="mi">8</span><span class="n">F</span><span class="p">:</span><span class="mi">7</span><span class="n">C</span><span class="p">:</span><span class="n">E7</span><span class="p">:</span><span class="mi">6</span><span class="n">B</span><span class="p">:</span><span class="n">DF</span><span class="p">:</span><span class="mi">2</span><span class="n">B</span><span class="p">:</span><span class="mi">6</span><span class="n">F</span><span class="p">:</span><span class="n">D6</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="n">B6</span><span class="p">:</span><span class="n">A6</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">62</span><span class="p">:</span><span class="n">D5</span><span class="p">:</span><span class="mi">7</span><span class="n">E</span><span class="p">:</span><span class="mi">4</span><span class="n">E</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">91</span><span class="p">:</span><span class="mi">91</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mi">95</span><span class="p">:</span><span class="n">BE</span><span class="p">:</span><span class="mi">2</span><span class="n">C</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">3</span><span class="n">F</span><span class="p">:</span><span class="n">B2</span><span class="p">:</span><span class="mi">67</span><span class="p">:</span><span class="mi">6</span><span class="n">F</span><span class="p">:</span><span class="n">DF</span><span class="p">:</span><span class="mi">3</span><span class="n">C</span>
<span class="n">a</span><span class="o">=</span><span class="n">setup</span><span class="p">:</span><span class="n">actpass</span>
<span class="n">a</span><span class="o">=</span><span class="n">mid</span><span class="p">:</span><span class="mi">0</span>
<span class="o">//...</span><span class="n">省略若干属性</span>
<span class="n">a</span><span class="o">=</span><span class="n">ssrc</span><span class="p">:</span><span class="mi">104648773</span> <span class="n">cname</span><span class="p">:</span><span class="n">XQRmiLwREWI1CiN0</span>
<span class="n">a</span><span class="o">=</span><span class="n">ssrc</span><span class="p">:</span><span class="mi">104648773</span> <span class="n">msid</span><span class="p">:</span><span class="n">rb3Uanb7CQq8HfZe0gexpjwoNCQai0AbUoQB</span> <span class="n">fc805128</span><span class="o">-</span><span class="n">e98d</span><span class="o">-</span><span class="mi">47</span><span class="n">d2</span><span class="o">-</span><span class="n">a9a6</span><span class="o">-</span><span class="n">b8976c91a404</span>
<span class="n">a</span><span class="o">=</span><span class="n">ssrc</span><span class="p">:</span><span class="mi">104648773</span> <span class="n">mslabel</span><span class="p">:</span><span class="n">rb3Uanb7CQq8HfZe0gexpjwoNCQai0AbUoQB</span>
<span class="n">a</span><span class="o">=</span><span class="n">ssrc</span><span class="p">:</span><span class="mi">104648773</span> <span class="n">label</span><span class="p">:</span><span class="n">fc805128</span><span class="o">-</span><span class="n">e98d</span><span class="o">-</span><span class="mi">47</span><span class="n">d2</span><span class="o">-</span><span class="n">a9a6</span><span class="o">-</span><span class="n">b8976c91a404</span>

<span class="n">m</span><span class="o">=</span><span class="n">video</span> <span class="mi">9</span> <span class="n">UDP</span><span class="o">/</span><span class="n">TLS</span><span class="o">/</span><span class="n">RTP</span><span class="o">/</span><span class="n">SAVPF</span> <span class="mi">96</span> <span class="mi">97</span> <span class="mi">98</span> <span class="mi">99</span> <span class="mi">100</span> <span class="mi">101</span> <span class="mi">127</span> <span class="mi">121</span> <span class="mi">125</span> <span class="mi">107</span> <span class="mi">108</span> <span class="mi">109</span> <span class="mi">124</span> <span class="mi">120</span> <span class="mi">123</span> <span class="mi">119</span> <span class="mi">35</span> <span class="mi">36</span> <span class="mi">41</span> <span class="mi">42</span> <span class="mi">114</span> <span class="mi">115</span> <span class="mi">116</span>
<span class="n">c</span><span class="o">=</span><span class="n">IN</span> <span class="n">IP4</span> <span class="mf">0.0.0.0</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtcp</span><span class="p">:</span><span class="mi">9</span> <span class="n">IN</span> <span class="n">IP4</span> <span class="mf">0.0.0.0</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">ufrag</span><span class="p">:</span><span class="n">u8aT</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">pwd</span><span class="p">:</span><span class="n">nTH</span><span class="o">+</span><span class="mi">98</span><span class="n">fL7o</span><span class="o">+</span><span class="n">XacAd</span><span class="o">//</span><span class="n">X7uStI</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">options</span><span class="p">:</span><span class="n">trickle</span>
<span class="n">a</span><span class="o">=</span><span class="n">fingerprint</span><span class="p">:</span><span class="n">sha</span><span class="o">-</span><span class="mi">256</span> <span class="mi">6</span><span class="n">E</span><span class="p">:</span><span class="n">FD</span><span class="p">:</span><span class="mi">8</span><span class="n">F</span><span class="p">:</span><span class="mi">7</span><span class="n">C</span><span class="p">:</span><span class="n">E7</span><span class="p">:</span><span class="mi">6</span><span class="n">B</span><span class="p">:</span><span class="n">DF</span><span class="p">:</span><span class="mi">2</span><span class="n">B</span><span class="p">:</span><span class="mi">6</span><span class="n">F</span><span class="p">:</span><span class="n">D6</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="n">B6</span><span class="p">:</span><span class="n">A6</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">62</span><span class="p">:</span><span class="n">D5</span><span class="p">:</span><span class="mi">7</span><span class="n">E</span><span class="p">:</span><span class="mi">4</span><span class="n">E</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">91</span><span class="p">:</span><span class="mi">91</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mi">95</span><span class="p">:</span><span class="n">BE</span><span class="p">:</span><span class="mi">2</span><span class="n">C</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">3</span><span class="n">F</span><span class="p">:</span><span class="n">B2</span><span class="p">:</span><span class="mi">67</span><span class="p">:</span><span class="mi">6</span><span class="n">F</span><span class="p">:</span><span class="n">DF</span><span class="p">:</span><span class="mi">3</span><span class="n">C</span>
<span class="n">a</span><span class="o">=</span><span class="n">setup</span><span class="p">:</span><span class="n">actpass</span>
<span class="n">a</span><span class="o">=</span><span class="n">mid</span><span class="p">:</span><span class="mi">1</span>
<span class="o">//...</span><span class="n">省略若干属性</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtcp</span><span class="o">-</span><span class="n">mux</span>
<span class="o">//...</span><span class="n">省略若干属性</span>
<span class="n">a</span><span class="o">=</span><span class="n">rid</span><span class="p">:</span><span class="n">high</span> <span class="n">send</span>
<span class="n">a</span><span class="o">=</span><span class="n">rid</span><span class="p">:</span><span class="n">middle</span> <span class="n">send</span>
<span class="n">a</span><span class="o">=</span><span class="n">rid</span><span class="p">:</span><span class="n">low</span> <span class="n">send</span>
<span class="n">a</span><span class="o">=</span><span class="n">simulcast</span><span class="p">:</span><span class="n">send</span> <span class="n">high</span><span class="p">;</span><span class="n">middle</span><span class="p">;</span><span class="n">low</span>

<span class="n">m</span><span class="o">=</span><span class="n">audio</span> <span class="mi">9</span> <span class="n">UDP</span><span class="o">/</span><span class="n">TLS</span><span class="o">/</span><span class="n">RTP</span><span class="o">/</span><span class="n">SAVPF</span> <span class="mi">111</span> <span class="mi">63</span> <span class="mi">103</span> <span class="mi">104</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">8</span> <span class="mi">106</span> <span class="mi">105</span> <span class="mi">13</span> <span class="mi">110</span> <span class="mi">112</span> <span class="mi">113</span> <span class="mi">126</span>
<span class="n">c</span><span class="o">=</span><span class="n">IN</span> <span class="n">IP4</span> <span class="mf">0.0.0.0</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtcp</span><span class="p">:</span><span class="mi">9</span> <span class="n">IN</span> <span class="n">IP4</span> <span class="mf">0.0.0.0</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">ufrag</span><span class="p">:</span><span class="n">u8aT</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">pwd</span><span class="p">:</span><span class="n">nTH</span><span class="o">+</span><span class="mi">98</span><span class="n">fL7o</span><span class="o">+</span><span class="n">XacAd</span><span class="o">//</span><span class="n">X7uStI</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">options</span><span class="p">:</span><span class="n">trickle</span>
<span class="n">a</span><span class="o">=</span><span class="n">fingerprint</span><span class="p">:</span><span class="n">sha</span><span class="o">-</span><span class="mi">256</span> <span class="mi">6</span><span class="n">E</span><span class="p">:</span><span class="n">FD</span><span class="p">:</span><span class="mi">8</span><span class="n">F</span><span class="p">:</span><span class="mi">7</span><span class="n">C</span><span class="p">:</span><span class="n">E7</span><span class="p">:</span><span class="mi">6</span><span class="n">B</span><span class="p">:</span><span class="n">DF</span><span class="p">:</span><span class="mi">2</span><span class="n">B</span><span class="p">:</span><span class="mi">6</span><span class="n">F</span><span class="p">:</span><span class="n">D6</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="n">B6</span><span class="p">:</span><span class="n">A6</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">62</span><span class="p">:</span><span class="n">D5</span><span class="p">:</span><span class="mi">7</span><span class="n">E</span><span class="p">:</span><span class="mi">4</span><span class="n">E</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">91</span><span class="p">:</span><span class="mi">91</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mi">95</span><span class="p">:</span><span class="n">BE</span><span class="p">:</span><span class="mi">2</span><span class="n">C</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">3</span><span class="n">F</span><span class="p">:</span><span class="n">B2</span><span class="p">:</span><span class="mi">67</span><span class="p">:</span><span class="mi">6</span><span class="n">F</span><span class="p">:</span><span class="n">DF</span><span class="p">:</span><span class="mi">3</span><span class="n">C</span>
<span class="n">a</span><span class="o">=</span><span class="n">setup</span><span class="p">:</span><span class="n">actpass</span>
<span class="n">a</span><span class="o">=</span><span class="n">mid</span><span class="p">:</span><span class="mi">2</span>
<span class="o">//...</span><span class="n">省略若干属性</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtcp</span><span class="o">-</span><span class="n">mux</span>

<span class="o">//...</span><span class="n">省略若干属性</span>

<span class="n">m</span><span class="o">=</span><span class="n">video</span> <span class="mi">9</span> <span class="n">UDP</span><span class="o">/</span><span class="n">TLS</span><span class="o">/</span><span class="n">RTP</span><span class="o">/</span><span class="n">SAVPF</span> <span class="mi">96</span> <span class="mi">97</span> <span class="mi">98</span> <span class="mi">99</span> <span class="mi">100</span> <span class="mi">101</span> <span class="mi">102</span> <span class="mi">122</span> <span class="mi">127</span> <span class="mi">121</span> <span class="mi">125</span> <span class="mi">107</span> <span class="mi">108</span> <span class="mi">109</span> <span class="mi">124</span> <span class="mi">120</span> <span class="mi">123</span> <span class="mi">119</span> <span class="mi">35</span> <span class="mi">36</span> <span class="mi">37</span> <span class="mi">38</span> <span class="mi">39</span> <span class="mi">40</span> <span class="mi">41</span> <span class="mi">42</span> <span class="mi">114</span> <span class="mi">115</span> <span class="mi">116</span> <span class="mi">43</span>
<span class="n">c</span><span class="o">=</span><span class="n">IN</span> <span class="n">IP4</span> <span class="mf">0.0.0.0</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtcp</span><span class="p">:</span><span class="mi">9</span> <span class="n">IN</span> <span class="n">IP4</span> <span class="mf">0.0.0.0</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">ufrag</span><span class="p">:</span><span class="n">u8aT</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">pwd</span><span class="p">:</span><span class="n">nTH</span><span class="o">+</span><span class="mi">98</span><span class="n">fL7o</span><span class="o">+</span><span class="n">XacAd</span><span class="o">//</span><span class="n">X7uStI</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">options</span><span class="p">:</span><span class="n">trickle</span>
<span class="n">a</span><span class="o">=</span><span class="n">fingerprint</span><span class="p">:</span><span class="n">sha</span><span class="o">-</span><span class="mi">256</span> <span class="mi">6</span><span class="n">E</span><span class="p">:</span><span class="n">FD</span><span class="p">:</span><span class="mi">8</span><span class="n">F</span><span class="p">:</span><span class="mi">7</span><span class="n">C</span><span class="p">:</span><span class="n">E7</span><span class="p">:</span><span class="mi">6</span><span class="n">B</span><span class="p">:</span><span class="n">DF</span><span class="p">:</span><span class="mi">2</span><span class="n">B</span><span class="p">:</span><span class="mi">6</span><span class="n">F</span><span class="p">:</span><span class="n">D6</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="n">B6</span><span class="p">:</span><span class="n">A6</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">62</span><span class="p">:</span><span class="n">D5</span><span class="p">:</span><span class="mi">7</span><span class="n">E</span><span class="p">:</span><span class="mi">4</span><span class="n">E</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">91</span><span class="p">:</span><span class="mi">91</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mi">95</span><span class="p">:</span><span class="n">BE</span><span class="p">:</span><span class="mi">2</span><span class="n">C</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">3</span><span class="n">F</span><span class="p">:</span><span class="n">B2</span><span class="p">:</span><span class="mi">67</span><span class="p">:</span><span class="mi">6</span><span class="n">F</span><span class="p">:</span><span class="n">DF</span><span class="p">:</span><span class="mi">3</span><span class="n">C</span>
<span class="n">a</span><span class="o">=</span><span class="n">setup</span><span class="p">:</span><span class="n">actpass</span>
<span class="n">a</span><span class="o">=</span><span class="n">mid</span><span class="p">:</span><span class="mi">3</span>
<span class="o">//...</span><span class="n">省略若干属性</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtcp</span><span class="o">-</span><span class="n">mux</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtcp</span><span class="o">-</span><span class="n">rsize</span>
<span class="o">//...</span><span class="n">省略若干属性</span>

<span class="n">m</span><span class="o">=</span><span class="n">application</span> <span class="mi">9</span> <span class="n">UDP</span><span class="o">/</span><span class="n">DTLS</span><span class="o">/</span><span class="n">SCTP</span> <span class="n">webrtc</span><span class="o">-</span><span class="n">datachannel</span>
<span class="n">c</span><span class="o">=</span><span class="n">IN</span> <span class="n">IP4</span> <span class="mf">0.0.0.0</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">ufrag</span><span class="p">:</span><span class="n">u8aT</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">pwd</span><span class="p">:</span><span class="n">nTH</span><span class="o">+</span><span class="mi">98</span><span class="n">fL7o</span><span class="o">+</span><span class="n">XacAd</span><span class="o">//</span><span class="n">X7uStI</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">options</span><span class="p">:</span><span class="n">trickle</span>
<span class="n">a</span><span class="o">=</span><span class="n">fingerprint</span><span class="p">:</span><span class="n">sha</span><span class="o">-</span><span class="mi">256</span> <span class="mi">6</span><span class="n">E</span><span class="p">:</span><span class="n">FD</span><span class="p">:</span><span class="mi">8</span><span class="n">F</span><span class="p">:</span><span class="mi">7</span><span class="n">C</span><span class="p">:</span><span class="n">E7</span><span class="p">:</span><span class="mi">6</span><span class="n">B</span><span class="p">:</span><span class="n">DF</span><span class="p">:</span><span class="mi">2</span><span class="n">B</span><span class="p">:</span><span class="mi">6</span><span class="n">F</span><span class="p">:</span><span class="n">D6</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="n">B6</span><span class="p">:</span><span class="n">A6</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">62</span><span class="p">:</span><span class="n">D5</span><span class="p">:</span><span class="mi">7</span><span class="n">E</span><span class="p">:</span><span class="mi">4</span><span class="n">E</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">91</span><span class="p">:</span><span class="mi">91</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mi">95</span><span class="p">:</span><span class="n">BE</span><span class="p">:</span><span class="mi">2</span><span class="n">C</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">3</span><span class="n">F</span><span class="p">:</span><span class="n">B2</span><span class="p">:</span><span class="mi">67</span><span class="p">:</span><span class="mi">6</span><span class="n">F</span><span class="p">:</span><span class="n">DF</span><span class="p">:</span><span class="mi">3</span><span class="n">C</span>
<span class="n">a</span><span class="o">=</span><span class="n">setup</span><span class="p">:</span><span class="n">actpass</span>
<span class="n">a</span><span class="o">=</span><span class="n">mid</span><span class="p">:</span><span class="mi">4</span>
<span class="n">a</span><span class="o">=</span><span class="n">sctp</span><span class="o">-</span><span class="n">port</span><span class="p">:</span><span class="mi">5000</span>
<span class="n">a</span><span class="o">=</span><span class="nb">max</span><span class="o">-</span><span class="n">message</span><span class="o">-</span><span class="n">size</span><span class="p">:</span><span class="mi">262144</span>
</pre></div>
</div>
<p>RTP 包 会带上 mid 和 rid 的扩展头</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">0</span>                   <span class="mi">1</span>                   <span class="mi">2</span>                   <span class="mi">3</span>
 <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="o">|</span>       <span class="mh">0xBE</span>    <span class="o">|</span>    <span class="mh">0xDE</span>       <span class="o">|</span>           <span class="n">length</span><span class="o">=</span><span class="mi">3</span>            <span class="o">|</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="o">|</span>  <span class="n">ID</span>   <span class="o">|</span> <span class="n">L</span><span class="o">=</span><span class="mi">0</span>   <span class="o">|</span>     <span class="n">mid</span>       <span class="o">|</span>  <span class="n">ID</span>   <span class="o">|</span>  <span class="n">L</span><span class="o">=</span><span class="mi">1</span>  <span class="o">|</span>   <span class="n">rid</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
      <span class="o">...</span><span class="n">data</span>   <span class="o">|</span>    <span class="mi">0</span> <span class="p">(</span><span class="n">pad</span><span class="p">)</span>    <span class="o">|</span>    <span class="mi">0</span> <span class="p">(</span><span class="n">pad</span><span class="p">)</span>    <span class="o">|</span>  <span class="n">ID</span>   <span class="o">|</span> <span class="n">L</span><span class="o">=</span><span class="mi">3</span>   <span class="o">|</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="o">|</span>                          <span class="n">other</span> <span class="n">extension</span>                      <span class="o">|</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</pre></div>
</div>
<p>这样我们就能够通过 mid 和 rid 来区分不同的媒体流</p>
<div class="line-block">
<div class="line">注意:</div>
<div class="line">1) mid 通常用来区分不同的媒体源（麦克风，摄像头或共享屏幕），而 rid
通常用来区分来自一个媒体源所发送的不同质量的媒体流 2) mid 和 rid
并不会始终附加在 RTP 包中，通常只会在开头一直到收到第一个 RTCP RR 包</div>
</div>
</section>
<section id="rtcp-rtp-media-session-m-line">
<h2><a class="toc-backref" href="#id13" role="doc-backlink">4. 关联 RTCP 与 RTP 数据包到相应的 media session(m-line)</a><a class="headerlink" href="#rtcp-rtp-media-session-m-line" title="Permalink to this heading"></a></h2>
<p>RTCP 消息一般是用来控制或反馈相应媒体会话(media session )的 RTP 流的,
如何将 RTCP 与相应的 RTP 流关联起来呢，尤其在多路复用的场景中。RTP
包头里有 SSRC, RTCP 包里也有 SSRC,
似乎关联起来也不难，其实很麻烦，因为每个media session 中由于支持
simulcast 会有多个 SSRC。 更好的方法是用一个 ID 将它们联系起来:</p>
<ol class="arabic simple">
<li><p>在 RTP 头里加上 mid 扩展，设置为 media session 中指明的 mid</p></li>
<li><p>在 RTCP 包中设置 SDES 的 mid item 为 media session 中指明的 mid</p></li>
</ol>
<blockquote>
<div><p>Offerers and answerers <a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc3264">RFC3264</a> can associate identification-tags
with “m=” sections within offers and answers, using the procedures
in <a class="reference external" href="https://www.rfc-editor.org/rfc/rfc8843#RFC5888">RFC5888</a>. Each identification-tag uniquely represents an “m=”
section.</p>
</div></blockquote>
<ul class="simple">
<li><p>defines a new SDP attribute, “bundle-only”, which can be used to
request that a specific “m=” section (and the associated media) be
used only if kept within a BUNDLE group.</p></li>
<li><p>updates RFC 3264 [<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc3264">RFC3264</a>], to also allow assigning a zero port
value to an “m=” section in cases where the media described by the
“m=” section is not disabled or
rejected.` &lt;<a class="reference external" href="https://www.rfc-editor.org/rfc/rfc8843#section-1.3-2.2">https://www.rfc-editor.org/rfc/rfc8843#section-1.3-2.2</a>&gt;`__</p></li>
<li><p>defines a new RTCP [<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc3550">RFC3550</a>] SDES item, ‘MID’, and a new RTP SDES
header extension that can be used to associate RTP streams with “m=”
sections.` &lt;<a class="reference external" href="https://www.rfc-editor.org/rfc/rfc8843#section-1.3-2.3">https://www.rfc-editor.org/rfc/rfc8843#section-1.3-2.3</a>&gt;`__</p></li>
<li><p>updates [<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc7941">RFC7941</a>] by adding an exception, for the MID RTP header
extension, to the requirement regarding protection of an SDES RTP
header extension carrying an SDES item for the MID RTP header
extension.</p></li>
</ul>
<img alt="https://upload-images.jianshu.io/upload_images/1598924-48580b2c2b25de20.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" src="https://upload-images.jianshu.io/upload_images/1598924-48580b2c2b25de20.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" />
</section>
<section id="id5">
<h2><a class="toc-backref" href="#id14" role="doc-backlink">参考资料</a><a class="headerlink" href="#id5" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://tools.ietf.org/html/rfc3550">RFC3550</a>: RTP 核心协议</p></li>
<li><p><a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc3711">RFC3711</a>: SRTP 安全的 RTP</p></li>
<li><p><a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc5761">RFC5761</a>: Multiplexing RTP Data and Control Packets on a Single
Port</p></li>
<li><p><a class="reference external" href="https://www.rfc-editor.org/rfc/rfc7941.html">RFC7941</a>: RTP Header
Extension for the RTP Control Protocol (RTCP) Source Description
Items - 旧版为 draft-ietf-avtext-sdes-hdr-ext-07</p></li>
<li><p><a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc8843">RFC8843</a>: Negotiating Media Multiplexing Using the Session
Description Protocol(SDP)</p></li>
<li><p><a class="reference external" href="https://www.rfc-editor.org/rfc/rfc8851.html">RFC8851</a>: RTP Payload Format Restrictions - 旧版为
draft-ietf-mmusic-rid-15</p></li>
<li><p><a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc8852">RFC8852</a>: RTP Stream Identifier Source Description (SDES)
draft-ietf-avtext-rid-09</p></li>
<li><p><a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc8853">RFC8853</a>: Using Simulcast in Session Description Protocol (SDP) and
RTP Sessions</p></li>
<li><p><a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc8858">RFC8858</a>: Indicating Exclusive Support of RTP and RTP Control
Protocol (RTCP) Multiplexing Using the Session Description Protocol
(SDP)</p></li>
<li><p><a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc8860">RFC8860</a>: Sending Multiple Types of Media in a Single RTP Session</p></li>
<li><p><a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc8872">RFC8872</a>: Guidelines for Using the Multiplexing Features of RTP to
Support Multiple Media Streams</p></li>
<li><p><a class="reference external" href="https://tools.ietf.org/html/rfc8834">RFC 8834</a>: Media Transport and Use of RTP in WebRTC</p></li>
<li><p><a class="reference external" href="http://tools.ietf.org/html/rfc5245">RFC 5245</a>: Interactive Connectivity Establishment (ICE): A Protocol
for Network Address Translator (NAT) Traversal for Offer/Answer
Protocols</p></li>
<li><p><a class="reference external" href="https://tools.ietf.org/html/rfc8445">RFC 8445</a>: Interactive Connectivity Establishment (ICE): A Protocol
for Network Address Translator (NAT) Traversal</p></li>
<li><p><a class="reference external" href="https://tools.ietf.org/html/rfc8489">RFC 8489</a>: Session Traversal Utilities for NAT (STUN)</p></li>
<li><p><a class="reference external" href="https://tools.ietf.org/html/rfc5766">RFC 5766</a>: Traversal Using Relays around NAT (TURN):Relay
Extensions to Session Traversal Utilities for NAT (STUN)</p></li>
<li><p><a class="reference external" href="https://tools.ietf.org/html/rfc5888">RFC 5888</a>: The Session Description Protocol (SDP) Grouping
Framework</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="webrtc_ndi.html" class="btn btn-neutral float-left" title="Network Device Interface" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../3.media/index.html" class="btn btn-neutral float-right" title="3. WebRTC 媒体" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021 ~ 2023, Walter Fan, Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>