<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>video adaptation &mdash; webrtc_tutorial 1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="video quality" href="video_quality.html" />
    <link rel="prev" title="视频编码" href="video_codec.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> webrtc_tutorial
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../0.tutorial/index.html">0. WebRTC 简明教程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1.basic/index.html">1. WebRTC 基础</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2.transport/index.html">2. WebRTC 传输</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">3. WebRTC 媒体</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">WebRTC 媒体概论</a></li>
<li class="toctree-l2"><a class="reference internal" href="webrtc_audio.html">WebRTC 音频</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="webrtc_video.html">WebRTC 视频</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="video_basic.html">Video Basic</a></li>
<li class="toctree-l3"><a class="reference internal" href="video_codec.html">视频编码</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">video adaptation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id3">概述</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="video_quality.html">video quality</a></li>
<li class="toctree-l3"><a class="reference internal" href="video_pipeline.html">Video Pipeline</a></li>
<li class="toctree-l3"><a class="reference internal" href="video_process.html">Video Process</a></li>
<li class="toctree-l3"><a class="reference internal" href="video_lip_sync.html">Video Lip Sync</a></li>
<li class="toctree-l3"><a class="reference internal" href="yuv.html">YUV 图像格式</a></li>
<li class="toctree-l3"><a class="reference internal" href="video_codec_h264.html">H.264 编码</a></li>
<li class="toctree-l3"><a class="reference internal" href="video_codec_av1.html">视频编码 AV1</a></li>
<li class="toctree-l3"><a class="reference internal" href="webrtc_video.html#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="webrtc_video.html#terms">Terms</a></li>
<li class="toctree-l3"><a class="reference internal" href="webrtc_video.html#video-file-format">Video File Format</a></li>
<li class="toctree-l3"><a class="reference internal" href="webrtc_video.html#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="webrtc_sharing.html">WebRTC Sharing</a></li>
<li class="toctree-l2"><a class="reference internal" href="webrtc_qos.html">WebRTC QoS</a></li>
<li class="toctree-l2"><a class="reference internal" href="webrtc_cc.html">WebRTC 拥塞控制</a></li>
<li class="toctree-l2"><a class="reference internal" href="webrtc_fec.html">WebRTC FEC</a></li>
<li class="toctree-l2"><a class="reference internal" href="webrtc_rtx.html">WebRTC RTX</a></li>
<li class="toctree-l2"><a class="reference internal" href="webrtc_red.html">WebRTC RED</a></li>
<li class="toctree-l2"><a class="reference internal" href="webrtc_temporal_scalability.html">Temporal scalability</a></li>
<li class="toctree-l2"><a class="reference internal" href="webrtc_feedback.html">WebRTC Feedback</a></li>
<li class="toctree-l2"><a class="reference internal" href="insertable_stream.html">Insertable Stream</a></li>
<li class="toctree-l2"><a class="reference internal" href="web_codec.html">Web Codecs</a></li>
<li class="toctree-l2"><a class="reference internal" href="web_transport.html">Web Transport</a></li>
<li class="toctree-l2"><a class="reference internal" href="webrtc_svc.html">WebRTC SVC</a></li>
<li class="toctree-l2"><a class="reference internal" href="webrtc_metrics.html">WebRTC Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="webrtc_e2e_delay.html">WebRTC E2E Delay</a></li>
<li class="toctree-l2"><a class="reference internal" href="webrtc_simulcast.html">WebRTC Simulcast</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../4.code/index.html">4. WebRTC 源码分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../5.practice/index.html">5. WebRTC 实践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../6.tool/index.html">5. WebRTC 工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="../7.misc/index.html">6. WebRTC 关联技术</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">webrtc_tutorial</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">3. WebRTC 媒体</a> &raquo;</li>
          <li><a href="webrtc_video.html">WebRTC 视频</a> &raquo;</li>
      <li>video adaptation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/3.media/video_adaptation.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="video-adaptation">
<h1>video adaptation<a class="headerlink" href="#video-adaptation" title="Permalink to this headline">¶</a></h1>
<table class="docutils align-default">
<colgroup>
<col style="width: 32%" />
<col style="width: 68%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><strong>Abstract</strong></p></td>
<td><p>Video Adaptation</p></td>
</tr>
<tr class="row-even"><td><p><strong>Authors</strong></p></td>
<td><p>Walter Fan</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Status</strong></p></td>
<td><p>WIP</p></td>
</tr>
<tr class="row-even"><td><p><strong>Updated</strong></p></td>
<td><p>2023-07-25</p></td>
</tr>
</tbody>
</table>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#id3" id="id5">概述</a></p>
<ul>
<li><p><a class="reference internal" href="#device-adaptation" id="id6">Device adaptation</a></p>
<ul>
<li><p><a class="reference internal" href="#encodeusageresource" id="id7">EncodeUsageResource</a></p></li>
<li><p><a class="reference internal" href="#qualityscaler" id="id8">QualityScaler</a></p></li>
<li><p><a class="reference internal" href="#qualityscalerqpusagehandlerinterface" id="id9">QualityScalerQpUsageHandlerInterface</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#network-adaptation" id="id10">Network adaptation</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#reference" id="id11">Reference</a></p></li>
</ul>
</div>
<section id="id3">
<h2><a class="toc-backref" href="#id5">概述</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>video 的编码或传输质量会受到网络带宽和设备能力的影响。</p>
<p>网络质量不佳，带宽受限，如果还要发送高质量的视频会很困难，因为质量越高，码率越大，所以我们需要降低传送的码率。
如果用户可以接受低质量的视频，那么这时候可以降低分辨率。如果用户不接受低质量视频，那么就需要忍受延迟，降低帧率或者有些丢帧。</p>
<p>另一方面，用于 WebRTC 应用的设备往往参差不齐，有高大上的 macbook pro, 也有老掉牙的老笔记本或台式机，或者轻便小巧的平板。
多媒体特别是视频的编解码是很耗费资源的, 这时候，需要根据设备的资源消耗情况，实时调整编码质量，如分辨率，帧率等，避免对系统资源主要是 CPU 的占用率过大。</p>
<p>对于视频的调整, 主要是调帧率和分辨率, 策略有 3 种</p>
<ul class="simple">
<li><p>MAINTAIN_FRAMERATE：保帧率，降分辨率，该模式的使用场景为视频模式。</p></li>
<li><p>MAINTAIN_RESOLUTION: 保分辨率降帧率，使用场景为屏幕共享或者文档模式，对清晰度要求较高的场景。</p></li>
<li><p>BALANCED: 平衡帧率与分辨率。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">enum</span> <span class="k">class</span> <span class="nc">DegradationPreference</span> <span class="p">{</span>
   <span class="o">//</span> <span class="n">Don</span><span class="s1">&#39;t take any actions based on over-utilization signals. Not part of the</span>
   <span class="o">//</span> <span class="n">web</span> <span class="n">API</span><span class="o">.</span>
   <span class="n">DISABLED</span><span class="p">,</span>
   <span class="o">//</span> <span class="n">On</span> <span class="n">over</span><span class="o">-</span><span class="n">use</span><span class="p">,</span> <span class="n">request</span> <span class="n">lower</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">possibly</span> <span class="n">causing</span> <span class="n">down</span><span class="o">-</span><span class="n">scaling</span><span class="o">.</span>
   <span class="n">MAINTAIN_FRAMERATE</span><span class="p">,</span>
   <span class="o">//</span> <span class="n">On</span> <span class="n">over</span><span class="o">-</span><span class="n">use</span><span class="p">,</span> <span class="n">request</span> <span class="n">lower</span> <span class="n">frame</span> <span class="n">rate</span><span class="p">,</span> <span class="n">possibly</span> <span class="n">causing</span> <span class="n">frame</span> <span class="n">drops</span><span class="o">.</span>
   <span class="n">MAINTAIN_RESOLUTION</span><span class="p">,</span>
   <span class="o">//</span> <span class="n">Try</span> <span class="n">to</span> <span class="n">strike</span> <span class="n">a</span> <span class="s2">&quot;pleasing&quot;</span> <span class="n">balance</span> <span class="n">between</span> <span class="n">frame</span> <span class="n">rate</span> <span class="ow">or</span> <span class="n">resolution</span><span class="o">.</span>
   <span class="n">BALANCED</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</div>
<p>webrtc api 层提供了自适应策略的设置接口，通过设置 videotrack 的 ContentHint 属性就可以了。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">enum</span> <span class="k">class</span> <span class="nc">ContentHint</span> <span class="p">{</span> <span class="n">kNone</span><span class="p">,</span> <span class="n">kFluid</span><span class="p">,</span> <span class="n">kDetailed</span><span class="p">,</span> <span class="n">kText</span> <span class="p">};</span>
</pre></div>
</div>
<p>ContentHint 为 kDetailed/kText 暗示了编码器保持分辨率，降帧率，设置为 kFluid，暗示编码器保持帧率，示例：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">void</span> <span class="n">StartVideo</span><span class="p">(){</span>
                       <span class="o">.....</span>
       <span class="n">auto</span> <span class="n">track</span> <span class="o">=</span> <span class="n">mSharedFactory</span><span class="o">-&gt;</span><span class="n">createVideoTrack</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">source</span><span class="p">);</span>
                       <span class="n">track</span><span class="o">-&gt;</span><span class="n">set_content_hint</span><span class="p">(</span><span class="n">webrtc</span><span class="p">::</span><span class="n">VideoTrackInterface</span><span class="p">::</span><span class="n">ContentHint</span><span class="p">::</span><span class="n">kFluid</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<section id="device-adaptation">
<h3><a class="toc-backref" href="#id6">Device adaptation</a><a class="headerlink" href="#device-adaptation" title="Permalink to this headline">¶</a></h3>
<p>设备的计算和存储资源对于视频的编解码, 捕获和渲染是有很大影响的. 如果设备性能太差, 则不适合进行高分辨率和高帧率的视频编解码.</p>
<p>在 webrtc library 中的 video 模块中有一个子模块 adaption, 它主要有如下的类来适应设备和网络状态</p>
<section id="encodeusageresource">
<h4><a class="toc-backref" href="#id7">EncodeUsageResource</a><a class="headerlink" href="#encodeusageresource" title="Permalink to this headline">¶</a></h4>
<p>Handles interaction with the OveruseDetector.</p>
</section>
<section id="qualityscaler">
<h4><a class="toc-backref" href="#id8">QualityScaler</a><a class="headerlink" href="#qualityscaler" title="Permalink to this headline">¶</a></h4>
<p>QualityScaler runs asynchronously and monitors QP values of encoded frames.
It holds a reference to a QualityScalerQpUsageHandlerInterface implementation to signal an overuse or underuse of QP
(which indicate a desire to scale the video stream down or up).</p>
</section>
<section id="qualityscalerqpusagehandlerinterface">
<h4><a class="toc-backref" href="#id9">QualityScalerQpUsageHandlerInterface</a><a class="headerlink" href="#qualityscalerqpusagehandlerinterface" title="Permalink to this headline">¶</a></h4>
<p>Reacts to QP being too high or too low.</p>
<p>For best quality, when QP is high it is desired to decrease the resolution or frame rate of the stream and when QP is low it is desired to increase the resolution or frame rate of the stream.</p>
<p>Whether to reconfigure the stream is ultimately up to the handler, which is able to respond asynchronously.</p>
</section>
</section>
<section id="network-adaptation">
<h3><a class="toc-backref" href="#id10">Network adaptation</a><a class="headerlink" href="#network-adaptation" title="Permalink to this headline">¶</a></h3>
<p>WebRTC 有一个网络拥塞和带宽估计的模块, 当检测到网络带宽有变化的(over-use, under-use), 就可以来调整视频的分辨率或帧率</p>
<table class="colwidths-given docutils align-default" id="id4">
<caption><span class="caption-text">分辨率对应的大约带宽</span><a class="headerlink" href="#id4" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>bandwidth</p></th>
<th class="head"><p>Resolution</p></th>
<th class="head"><p>Comments</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>64kbps</p></td>
<td><p>90p</p></td>
<td><p>160 x 90</p></td>
</tr>
<tr class="row-odd"><td><p>128kbps</p></td>
<td><p>180p</p></td>
<td><p>320 x 180</p></td>
</tr>
<tr class="row-even"><td><p>448kbps</p></td>
<td><p>360p</p></td>
<td><p>640 x 360</p></td>
</tr>
<tr class="row-odd"><td><p>1536kbps</p></td>
<td><p>720p</p></td>
<td><p>1280 x 720</p></td>
</tr>
<tr class="row-even"><td><p>4mbps</p></td>
<td><p>1080p</p></td>
<td><p>1920 x 1080, may more than 4mbps, 2mbps at least</p></td>
</tr>
<tr class="row-odd"><td><p>12mbps</p></td>
<td><p>2K</p></td>
<td><p>3840 × 2160, may more than 12mbps</p></td>
</tr>
<tr class="row-even"><td><p>20mbps</p></td>
<td><p>4K</p></td>
<td><p>7680 × 4320, may more than 20mbps</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="reference">
<h2><a class="toc-backref" href="#id11">Reference</a><a class="headerlink" href="#reference" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://xie.infoq.cn/article/50b7931b8a023f8ca7f25d4e9">Webrtc video framerate/resolution 自适应</a></p></li>
<li><p><a class="reference external" href="https://source.chromium.org/chromium/chromium/src/+/main:third_party/webrtc/video/adaptation/overuse_frame_detector.h">overuse_frame_detector</a></p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="video_codec.html" class="btn btn-neutral float-left" title="视频编码" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="video_quality.html" class="btn btn-neutral float-right" title="video quality" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Walter Fan, Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>